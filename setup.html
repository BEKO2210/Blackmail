<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AEGIS — Setup</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="aegis-app">

    <header class="aegis-header">
      <a href="index.html" class="aegis-logo">
        <div class="aegis-logo-icon"><img src="asset/aegis-logo-256.png" alt="AEGIS"></div>
        <span class="aegis-logo-text" data-text="AEGIS">AEGIS</span>
      </a>
      <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation" aria-expanded="false">
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
      </button>
      <nav class="aegis-nav" id="aegisNav">
        <div class="nav-links">
          <a href="index.html" data-i18n="nav.home">Home</a>
          <a href="setup.html" data-i18n="nav.setup">Setup</a>
          <a href="checkin.html" data-i18n="nav.checkin">Check-in</a>
          <a href="guardian.html" data-i18n="nav.guardian">Guardian</a>
          <a href="verify.html" data-i18n="nav.verify">Verify</a>
          <a href="howitworks.html" data-i18n="nav.howitworks">How It Works</a>
          <div class="nav-divider"></div>
          <a href="privacy.html" data-i18n="nav.privacy">Privacy</a>
          <a href="imprint.html" data-i18n="nav.imprint">Imprint</a>
        </div>
        <div class="lang-toggle">
          <button class="lang-btn active" data-lang="en">EN</button>
          <button class="lang-btn" data-lang="de">DE</button>
        </div>
      </nav>
    </header>

    <main class="aegis-main">
      <h1 data-i18n="setup.title">Setup</h1>
      <p class="subtitle" data-i18n="setup.subtitle">Step by step through the configuration. Everything happens locally in your browser.</p>

      <!-- Mobile Wizard Indicator -->
      <div class="wizard-current" id="wizardCurrent" data-i18n="setup.step.label.1">Passphrase</div>

      <!-- Wizard Progress -->
      <div class="wizard-progress">
        <div class="wizard-step active" id="ws1">
          <div class="wizard-step-dot">1</div>
          <span class="wizard-step-label" data-i18n="setup.step.label.1">Passphrase</span>
        </div>
        <div class="wizard-step-line"></div>
        <div class="wizard-step" id="ws2">
          <div class="wizard-step-dot">2</div>
          <span class="wizard-step-label" data-i18n="setup.step.label.2">Evidence</span>
        </div>
        <div class="wizard-step-line"></div>
        <div class="wizard-step" id="ws3">
          <div class="wizard-step-dot">3</div>
          <span class="wizard-step-label" data-i18n="setup.step.label.3">Guardians</span>
        </div>
        <div class="wizard-step-line"></div>
        <div class="wizard-step" id="ws4">
          <div class="wizard-step-dot">4</div>
          <span class="wizard-step-label" data-i18n="setup.step.label.4">Complete</span>
        </div>
      </div>

      <!-- STEP 1: Passphrase -->
      <div id="step1" class="card animate-in">
        <div class="card-header">
          <h2 class="card-title" data-i18n="setup.step1.title">Set Passphrase</h2>
          <p class="card-desc" data-i18n="setup.step1.desc">Choose two passphrases: a normal one and a duress passphrase for emergencies.</p>
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="setup.step1.passphrase.label">Passphrase</label>
          <input type="password" id="passphrase" class="form-input form-input-mono"
                 data-i18n-placeholder="setup.step1.passphrase.placeholder"
                 placeholder="Your main passphrase..." autocomplete="off">
          <div class="strength-bar strength-0" id="strengthBar">
            <div class="strength-fill"></div>
          </div>
          <span class="strength-label" id="strengthLabel"></span>
          <span class="form-hint" data-i18n="setup.step1.passphrase.hint">At least 12 characters. The longer, the more secure.</span>
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="setup.step1.confirm.label">Confirm Passphrase</label>
          <input type="password" id="passphraseConfirm" class="form-input form-input-mono"
                 data-i18n-placeholder="setup.step1.confirm.placeholder"
                 placeholder="Repeat passphrase..." autocomplete="off">
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="setup.step1.duress.label">Duress Passphrase (Coercion Code)</label>
          <input type="password" id="duressPhrase" class="form-input form-input-mono"
                 data-i18n-placeholder="setup.step1.duress.placeholder"
                 placeholder="Your secret emergency code..." autocomplete="off">
          <details class="info-details">
            <summary data-i18n="setup.step1.duress.learnmore">What is a duress code?</summary>
            <div class="info-content" data-i18n="setup.step1.duress.explanation">A duress code is a secondary passphrase that produces a check-in token which looks completely normal to an attacker watching over your shoulder, but contains a hidden flag that your guardians can detect. If they see a duress token, they know you are being coerced and should immediately begin the escalation process.</div>
          </details>
          <span class="form-hint" data-i18n="setup.step1.duress.hint">When you enter this code during check-in, everything looks normal — but your guardians detect the hidden signal. Must differ from the main passphrase.</span>
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="setup.step1.interval.label">Check-in Interval</label>
          <select id="checkinInterval" class="form-select">
            <option value="24" data-i18n="setup.step1.interval.24">Every 24 hours</option>
            <option value="48" selected data-i18n="setup.step1.interval.48">Every 48 hours</option>
            <option value="72" data-i18n="setup.step1.interval.72">Every 72 hours</option>
            <option value="168" data-i18n="setup.step1.interval.168">Every 7 days</option>
            <option value="336" data-i18n="setup.step1.interval.336">Every 14 days</option>
          </select>
        </div>

        <div class="alert alert-warning hidden" id="step1Error">
          <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4m0 4h.01"/></svg></span>
          <span id="step1ErrorText"></span>
        </div>

        <div class="btn-group" style="justify-content: flex-end;">
          <button class="btn btn-primary" onclick="goToStep(2)"><span data-i18n="setup.btn.next">Next</span> &#x2192;</button>
        </div>
      </div>

      <!-- STEP 2: Evidence Upload -->
      <div id="step2" class="card hidden">
        <div class="card-header">
          <h2 class="card-title" data-i18n="setup.step2.title">Upload Evidence</h2>
          <p class="card-desc" data-i18n="setup.step2.desc">Upload the files to be protected. Everything is encrypted locally.</p>
        </div>

        <div class="alert alert-info">
          <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg></span>
          <div data-i18n="setup.step2.metadata.info">Images are automatically stripped of metadata (EXIF, GPS, camera info).</div>
        </div>

        <div class="upload-zone" id="uploadZone">
          <div class="upload-zone-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><path d="M17 8l-5-5-5 5"/><path d="M12 3v12"/></svg></div>
          <div class="upload-zone-text" data-i18n="setup.step2.upload.text">Drag files here or click to upload</div>
          <div class="upload-zone-hint" data-i18n="setup.step2.upload.hint">Documents, photos, videos, text — all formats</div>
          <input type="file" id="fileInput" multiple style="display:none">
        </div>

        <div class="file-list" id="fileList"></div>

        <div class="form-group mt-6">
          <label class="form-label" data-i18n="setup.step2.note.label">Optional Note (will be encrypted)</label>
          <textarea id="evidenceNote" class="form-textarea"
                    data-i18n-placeholder="setup.step2.note.placeholder"
                    placeholder="Context, explanations, instructions for the guardians..."></textarea>
        </div>

        <div class="alert alert-warning hidden" id="step2Error">
          <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4m0 4h.01"/></svg></span>
          <span id="step2ErrorText"></span>
        </div>

        <div class="btn-group" style="justify-content: space-between;">
          <button class="btn btn-ghost" onclick="goToStep(1)">&#x2190; <span data-i18n="setup.btn.back">Back</span></button>
          <button class="btn btn-primary" onclick="goToStep(3)"><span data-i18n="setup.btn.encrypt">Encrypt &amp; Continue</span> &#x2192;</button>
        </div>
      </div>

      <!-- STEP 3: Guardian Config -->
      <div id="step3" class="card hidden">
        <div class="card-header">
          <h2 class="card-title" data-i18n="setup.step3.title">Configure Guardians</h2>
          <p class="card-desc" data-i18n="setup.step3.desc">Define how many trusted persons receive fragments and how many are needed for decryption.</p>
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="setup.step3.total.label">Number of Guardians (N)</label>
          <select id="totalGuardians" class="form-select" onchange="updateThresholdOptions()">
            <option value="3" data-i18n="setup.step3.total.3">3 Guardians</option>
            <option value="5" selected data-i18n="setup.step3.total.5">5 Guardians</option>
            <option value="7" data-i18n="setup.step3.total.7">7 Guardians</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="setup.step3.threshold.label">Threshold (M) — Minimum for Decryption</label>
          <select id="threshold" class="form-select">
          </select>
          <span class="form-hint" data-i18n="setup.step3.threshold.hint">Higher threshold = more secure against betrayal, but harder during escalation.</span>
        </div>

        <div id="processingIndicator" class="hidden">
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-label">
              <span id="progressText"></span>
              <span id="progressPercent">0%</span>
            </div>
          </div>
        </div>

        <div class="alert alert-warning hidden" id="step3Error">
          <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4m0 4h.01"/></svg></span>
          <span id="step3ErrorText"></span>
        </div>

        <div class="btn-group" style="justify-content: space-between;">
          <button class="btn btn-ghost" onclick="goToStep(2)">&#x2190; <span data-i18n="setup.btn.back">Back</span></button>
          <button class="btn btn-primary" id="generateBtn" onclick="generatePackage()">
            <svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg> <span data-i18n="setup.btn.generate">Generate Package</span>
          </button>
        </div>
      </div>

      <!-- STEP 4: Complete -->
      <div id="step4" class="card hidden">
        <div class="card-header">
          <h2 class="card-title" data-i18n="setup.step4.title">AEGIS is Ready</h2>
          <p class="card-desc" data-i18n="setup.step4.desc">Your evidence package has been encrypted and guardian kits created.</p>
        </div>

        <div class="alert alert-success">
          <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></span>
          <div data-i18n="setup.step4.success">All files have been encrypted with AES-256-GCM. The key has been split into fragments.</div>
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="setup.step4.proof.label">Proof of Existence (SHA-256)</label>
          <div class="hash-display" id="proofHash">
            <button class="copy-btn" id="copyHashBtn" onclick="copyHash()" data-i18n="copy">Copy</button>
            <span id="proofHashText">—</span>
          </div>
          <span class="form-hint" data-i18n="setup.step4.proof.hint">Post this hash publicly (Twitter, blog, etc.) as proof that your information existed at this point in time.</span>
        </div>

        <h3 class="mt-6 mb-4" data-i18n="setup.step4.downloads">Downloads</h3>

        <div id="downloadSection">
          <button class="btn btn-dark btn-block mb-4" id="downloadPackageBtn" onclick="downloadPackage()">
            <svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/></svg> <span data-i18n="setup.step4.download.package">Download Encrypted Evidence Package</span>
          </button>
          <div id="guardianDownloads"></div>
        </div>

        <div class="card mt-6" style="background: var(--bg-input); border: none; box-shadow: none;">
          <h3 class="mb-4" data-i18n="setup.step4.nextsteps">Next Steps</h3>
          <div class="card-desc" style="line-height: 2;">
            <span data-i18n="setup.step4.nextstep.1">Store evidence package safely (USB, cloud, IPFS)</span><br>
            <span data-i18n="setup.step4.nextstep.2">Distribute guardian kits to trusted persons</span><br>
            <span data-i18n="setup.step4.nextstep.3">Post Proof of Existence hash publicly</span><br>
            <span data-i18n="setup.step4.nextstep.4">Perform your first check-in</span><br>
            <span data-i18n="setup.step4.nextstep.5">Inform guardians about their kit and brief them</span>
          </div>
        </div>

        <div class="btn-group" style="justify-content: center;">
          <a href="checkin.html" class="btn btn-primary btn-lg">&#x2192; <span data-i18n="setup.step4.goto.checkin">Go to Check-in</span></a>
        </div>
      </div>

    </main>

    <footer class="aegis-footer">
      <div class="footer-links">
        <a href="privacy.html" data-i18n="footer.privacy">Privacy</a>
        <span class="footer-sep">|</span>
        <a href="imprint.html" data-i18n="footer.imprint">Imprint</a>
        <span class="footer-sep">|</span>
        <a href="howitworks.html" data-i18n="footer.howitworks">How It Works</a>
      </div>
      <p data-i18n="footer.text">AEGIS — No data leaves your browser</p>
    </footer>

  </div>

  <script src="js/icons.js"></script>
  <script src="js/crypto.js"></script>
  <script src="js/shamir.js"></script>
  <script src="js/checkin.js"></script>
  <script src="js/lang.js"></script>
  <script src="js/main.js"></script>
  <script>
    'use strict';

    let currentStep = 1;
    let uploadedFiles = [];
    let generatedPackage = null;
    let guardianKits = null;

    const strengthKeys = ['', 'strength.weak', 'strength.medium', 'strength.good', 'strength.strong'];

    function goToStep(step) {
      if (step > currentStep) {
        if (!validateStep(currentStep)) return;
      }
      document.getElementById('step' + currentStep).classList.add('hidden');
      for (var i = 1; i <= 4; i++) {
        var ws = document.getElementById('ws' + i);
        ws.classList.remove('active', 'completed');
        if (i < step) ws.classList.add('completed');
        if (i === step) ws.classList.add('active');
      }
      currentStep = step;
      var newStep = document.getElementById('step' + step);
      newStep.classList.remove('hidden');
      newStep.classList.add('animate-in');
      var wizardCurrent = document.getElementById('wizardCurrent');
      wizardCurrent.textContent = AegisLang.t('setup.step.label.' + step);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateStep(step) {
      if (step === 1) {
        var pass = document.getElementById('passphrase').value;
        var confirm = document.getElementById('passphraseConfirm').value;
        var duress = document.getElementById('duressPhrase').value;
        if (pass.length < 8) {
          showError('step1', AegisLang.t('setup.error.passphrase.short'));
          return false;
        }
        if (pass !== confirm) {
          showError('step1', AegisLang.t('setup.error.passphrase.mismatch'));
          return false;
        }
        if (!duress) {
          showError('step1', AegisLang.t('setup.error.duress.empty'));
          return false;
        }
        if (pass === duress) {
          showError('step1', AegisLang.t('setup.error.duress.same'));
          return false;
        }
        hideError('step1');
        return true;
      }
      if (step === 2) {
        if (uploadedFiles.length === 0) {
          showError('step2', AegisLang.t('setup.error.files.empty'));
          return false;
        }
        hideError('step2');
        return true;
      }
      return true;
    }

    function showError(stepId, msg) {
      var el = document.getElementById(stepId + 'Error');
      el.classList.remove('hidden');
      document.getElementById(stepId + 'ErrorText').textContent = msg;
    }

    function hideError(stepId) {
      document.getElementById(stepId + 'Error').classList.add('hidden');
    }

    function updateStrengthLabel() {
      var value = document.getElementById('passphrase').value;
      var strength = AegisCrypto.estimateStrength(value);
      document.getElementById('strengthBar').className = 'strength-bar strength-' + strength;
      var label = strengthKeys[strength] ? AegisLang.t(strengthKeys[strength]) : '';
      document.getElementById('strengthLabel').textContent = label;
    }

    function renderFileList() {
      var list = document.getElementById('fileList');
      if (uploadedFiles.length === 0) {
        list.innerHTML = '';
        return;
      }
      list.innerHTML = uploadedFiles.map(function (file, i) {
        return '<div class="file-item animate-in">' +
          '<div class="file-item-info">' +
            '<span class="file-item-icon">' + getFileIcon(file.type) + '</span>' +
            '<span class="file-item-name">' + escapeHtml(file.name) + '</span>' +
          '</div>' +
          '<span class="file-item-size">' + formatSize(file.size) + '</span>' +
          '<button class="file-item-remove" onclick="removeFile(' + i + ')" data-i18n-title="remove" title="' + escapeHtml(AegisLang.t('remove')) + '">&#x2715;</button>' +
        '</div>';
      }).join('');
    }

    function removeFile(index) {
      uploadedFiles.splice(index, 1);
      renderFileList();
    }

    async function handleFiles(fileList) {
      for (var i = 0; i < fileList.length; i++) {
        var file = fileList[i];
        var processedFile = file;
        if (file.type.startsWith('image/')) {
          try {
            processedFile = await AegisCrypto.stripImageMetadata(file);
          } catch (e) {
            console.warn('Metadata stripping failed:', e);
          }
        }
        uploadedFiles.push(processedFile);
      }
      renderFileList();
    }

    function updateThresholdOptions() {
      var total = parseInt(document.getElementById('totalGuardians').value);
      var select = document.getElementById('threshold');
      select.innerHTML = '';
      for (var i = 2; i <= total; i++) {
        var opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i + ' ' + AegisLang.t('setup.step3.threshold.of') + ' ' + total;
        if (i === Math.ceil(total * 0.6)) opt.selected = true;
        select.appendChild(opt);
      }
    }

    async function generatePackage() {
      var passphrase = document.getElementById('passphrase').value;
      var totalGuardians = parseInt(document.getElementById('totalGuardians').value);
      var threshold = parseInt(document.getElementById('threshold').value);
      var interval = parseInt(document.getElementById('checkinInterval').value);
      var note = document.getElementById('evidenceNote').value;

      var btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.innerHTML = AegisIcons.loader + ' ' + AegisLang.t('setup.btn.generating');
      document.getElementById('processingIndicator').classList.remove('hidden');

      try {
        updateProgress(10, AegisLang.t('setup.progress.metadata'));
        var metadata = {
          note: note || null,
          checkinIntervalHours: interval,
          totalGuardians: totalGuardians,
          threshold: threshold,
          createdAt: new Date().toISOString()
        };

        updateProgress(25, AegisLang.t('setup.progress.encrypting'));
        var result = await AegisCrypto.createEvidencePackage(uploadedFiles, metadata, passphrase);

        updateProgress(60, AegisLang.t('setup.progress.fragmenting'));
        var encoder = new TextEncoder();
        var passphraseBytes = encoder.encode(passphrase);
        var shares = AegisShamir.split(passphraseBytes, totalGuardians, threshold);

        updateProgress(80, AegisLang.t('setup.progress.kits'));
        guardianKits = AegisShamir.createGuardianKits(shares, result.package.id, interval);

        updateProgress(95, AegisLang.t('setup.progress.finalizing'));
        generatedPackage = result;

        var duressPhrase = document.getElementById('duressPhrase').value;
        var configForCheckin = {
          packageId: result.package.id,
          interval: interval,
          passphraseHash: await AegisCrypto.sha256(passphrase),
          duressHash: await AegisCrypto.sha256(duressPhrase)
        };
        localStorage.setItem('aegis_config', JSON.stringify(configForCheckin));

        updateProgress(100, AegisLang.t('setup.progress.done'));

        setTimeout(function () {
          showResults(result, guardianKits);
          goToStep(4);
        }, 500);
      } catch (err) {
        console.error('Package generation failed:', err);
        showError('step3', AegisLang.t('setup.error.general') + err.message);
        btn.disabled = false;
        btn.innerHTML = AegisIcons.lock + ' ' + AegisLang.t('setup.btn.generate');
        document.getElementById('processingIndicator').classList.add('hidden');
      }
    }

    function updateProgress(percent, text) {
      document.getElementById('progressFill').style.width = percent + '%';
      document.getElementById('progressPercent').textContent = percent + '%';
      document.getElementById('progressText').textContent = text;
    }

    function showResults(result, kits) {
      document.getElementById('proofHashText').textContent = result.combinedProofHash;
      var downloadsHtml = '';
      for (var i = 0; i < kits.length; i++) {
        downloadsHtml += '<button class="btn btn-secondary btn-block mb-4" onclick="downloadGuardianKit(' + i + ')">' +
          AegisIcons.share + ' ' + AegisLang.t('setup.step4.download.guardian') + ' #' + (i + 1) +
          '</button>';
      }
      document.getElementById('guardianDownloads').innerHTML = downloadsHtml;
    }

    function downloadPackage() {
      if (!generatedPackage) return;
      downloadFile(
        JSON.stringify(generatedPackage.package, null, 2),
        'aegis-package-' + generatedPackage.package.id.substring(0, 8) + '.json',
        'application/json'
      );
    }

    function downloadGuardianKit(index) {
      if (!guardianKits || !guardianKits[index]) return;
      downloadFile(
        JSON.stringify(guardianKits[index], null, 2),
        'aegis-guardian-kit-' + (index + 1) + '.json',
        'application/json'
      );
    }

    function copyHash() {
      navigator.clipboard.writeText(document.getElementById('proofHashText').textContent).then(function () {
        var btn = document.getElementById('copyHashBtn');
        btn.textContent = '\u2713 ' + AegisLang.t('copied');
        setTimeout(function () {
          btn.textContent = AegisLang.t('copy');
        }, 2000);
      });
    }

    function refreshDynamicContent() {
      updateStrengthLabel();
      updateThresholdOptions();
      renderFileList();
      var wizardCurrent = document.getElementById('wizardCurrent');
      wizardCurrent.textContent = AegisLang.t('setup.step.label.' + currentStep);
      var copyBtn = document.getElementById('copyHashBtn');
      if (copyBtn) {
        copyBtn.textContent = AegisLang.t('copy');
      }
      if (generatedPackage && guardianKits) {
        showResults(generatedPackage, guardianKits);
      }
    }

    document.addEventListener('aegis-lang-change', function () {
      refreshDynamicContent();
    });

    document.addEventListener('aegis-ready', function () {
      // Setup passphrase strength listener
      document.getElementById('passphrase').addEventListener('input', function () {
        updateStrengthLabel();
      });

      // Setup upload zone listeners
      var uploadZone = document.getElementById('uploadZone');
      var fileInput = document.getElementById('fileInput');

      uploadZone.addEventListener('click', function () {
        fileInput.click();
      });

      uploadZone.addEventListener('dragover', function (e) {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
      });

      uploadZone.addEventListener('dragleave', function () {
        uploadZone.classList.remove('drag-over');
      });

      uploadZone.addEventListener('drop', function (e) {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener('change', function () {
        handleFiles(fileInput.files);
        fileInput.value = '';
      });

      // Initialize threshold options with i18n strings
      updateThresholdOptions();
    });
  </script>
</body>
</html>
