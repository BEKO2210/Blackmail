<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AEGIS â€” Check-in</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="aegis-app">

    <header class="aegis-header">
      <a href="index.html" class="aegis-logo">
        <div class="aegis-logo-icon">A</div>
        <span class="aegis-logo-text">AEGIS</span>
      </a>
      <nav class="aegis-nav">
        <a href="setup.html">Setup</a>
        <a href="checkin.html" class="active">Check-in</a>
        <a href="guardian.html">Guardian</a>
        <a href="verify.html">Verify</a>
      </nav>
    </header>

    <main class="aegis-main">
      <h1>Check-in</h1>
      <p class="subtitle">Melde dich regelmÃ¤ÃŸig, um den Dead Man's Switch zurÃ¼ckzusetzen.</p>

      <div class="alert alert-warning" id="noConfigAlert" style="display:none">
        <span class="alert-icon">âš ï¸</span>
        <div>Kein AEGIS-Profil gefunden. Bitte zuerst die <a href="setup.html" style="color: inherit; font-weight: 600;">Einrichtung</a> durchfÃ¼hren.</div>
      </div>

      <div class="card" id="checkinCard">
        <div class="card-header">
          <h2 class="card-title">ğŸ”‘ Passphrase eingeben</h2>
          <p class="card-desc">Gib deine Passphrase ein, um ein Check-in-Token zu generieren. Sende das Token an deine Guardians.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Passphrase</label>
          <input type="password" id="checkinPass" class="form-input form-input-mono" 
                 placeholder="Deine Passphrase..." autocomplete="off"
                 onkeydown="if(event.key==='Enter') performCheckin()">
        </div>

        <div class="alert alert-warning hidden" id="checkinError">
          <span class="alert-icon">âš ï¸</span>
          <span id="checkinErrorText"></span>
        </div>

        <button class="btn btn-primary btn-block btn-lg" onclick="performCheckin()">âœ“ Check-in durchfÃ¼hren</button>
      </div>

      <div id="tokenResult" class="hidden">
        <div class="token-display" id="tokenDisplay">
          <div style="font-size: 14px; font-weight: 500; color: var(--text-secondary);">Dein Check-in Token</div>
          <div class="token-code" id="tokenCode">â€”</div>
          <div class="token-time" id="tokenTime">â€”</div>
        </div>

        <div class="card">
          <h3 class="card-title mb-4">Token an Guardians senden</h3>
          <p class="card-desc mb-4">Kopiere das vollstÃ¤ndige Token und sende es an deine Guardians. Sie kÃ¶nnen es auf der Guardian-Seite verifizieren.</p>
          <div class="hash-display" id="fullToken" style="font-size: 11px;">
            <button class="copy-btn" onclick="copyToken()">Kopieren</button>
            <span id="fullTokenText">â€”</span>
          </div>
          <div class="btn-group" style="justify-content: center;">
            <button class="btn btn-secondary" onclick="copyToken()">ğŸ“‹ Token kopieren</button>
            <button class="btn btn-secondary" onclick="downloadToken()">ğŸ’¾ Als Datei speichern</button>
          </div>
        </div>

        <div class="alert alert-info mt-4">
          <span class="alert-icon">â„¹ï¸</span>
          <div><strong>NÃ¤chstes Check-in:</strong> <span id="nextCheckin">â€”</span><br>Sende das Token Ã¼ber einen sicheren Kanal (Signal, persÃ¶nlich, etc.)</div>
        </div>
      </div>

      <div class="card mt-6" id="historyCard">
        <h3 class="card-title">Letzte Check-ins</h3>
        <div id="checkinHistory" class="mt-4 text-sm text-muted">Noch keine Check-ins durchgefÃ¼hrt.</div>
      </div>
    </main>

    <footer class="aegis-footer">AEGIS v1.0 â€” Keine Daten verlassen deinen Browser</footer>
  </div>

  <script src="crypto.js"></script>
  <script src="checkin.js"></script>
  <script>
    'use strict';
    let config = null;
    let lastToken = null;

    function init() {
      const stored = localStorage.getItem('aegis_config');
      if (!stored) { document.getElementById('noConfigAlert').style.display = 'flex'; return; }
      config = JSON.parse(stored);
      loadHistory();
    }

    async function performCheckin() {
      if (!config) { document.getElementById('noConfigAlert').style.display = 'flex'; return; }
      const input = document.getElementById('checkinPass').value;
      if (!input) { showCheckinError('Bitte Passphrase eingeben.'); return; }

      const inputHash = await AegisCrypto.sha256(input);
      const isNormal = inputHash === config.passphraseHash;
      const isDuress = inputHash === config.duressHash;
      if (!isNormal && !isDuress) { showCheckinError('UngÃ¼ltige Passphrase.'); return; }
      hideCheckinError();

      const timestamp = new Date().toISOString();
      const nonce = AegisCrypto.generateId(8);
      const payload = { t: timestamp, n: nonce, p: config.packageId, _d: isDuress ? '1' : '0' };
      const tokenString = JSON.stringify(payload);
      const tokenHash = await AegisCrypto.sha256(tokenString);

      const token = { aegis_checkin: true, version: '1.0.0', timestamp, package: config.packageId, token: tokenHash, payload: btoa(tokenString) };
      lastToken = token;

      const displayCode = `AEGIS-${tokenHash.substring(0, 8).toUpperCase()}-${timestamp.split('T')[0]}`;
      document.getElementById('tokenCode').textContent = displayCode;
      document.getElementById('tokenTime').textContent = new Date(timestamp).toLocaleString('de-DE');
      document.getElementById('fullTokenText').textContent = JSON.stringify(token);

      const nextDate = new Date(Date.now() + config.interval * 60 * 60 * 1000);
      document.getElementById('nextCheckin').textContent = nextDate.toLocaleString('de-DE');

      document.getElementById('tokenResult').classList.remove('hidden');
      document.getElementById('tokenResult').classList.add('animate-in');
      saveCheckin(timestamp, displayCode);
      document.getElementById('checkinPass').value = '';
      document.getElementById('tokenResult').scrollIntoView({ behavior: 'smooth' });
    }

    function showCheckinError(msg) { document.getElementById('checkinError').classList.remove('hidden'); document.getElementById('checkinErrorText').textContent = msg; }
    function hideCheckinError() { document.getElementById('checkinError').classList.add('hidden'); }

    function copyToken() {
      if (!lastToken) return;
      navigator.clipboard.writeText(JSON.stringify(lastToken)).then(() => {
        document.querySelectorAll('.copy-btn').forEach(btn => { btn.textContent = 'âœ“ Kopiert'; setTimeout(() => btn.textContent = 'Kopieren', 2000); });
      });
    }

    function downloadToken() {
      if (!lastToken) return;
      const blob = new Blob([JSON.stringify(lastToken, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `aegis-checkin-${new Date().toISOString().split('T')[0]}.json`; a.click();
      URL.revokeObjectURL(url);
    }

    function saveCheckin(timestamp, code) {
      let history = JSON.parse(localStorage.getItem('aegis_history') || '[]');
      history.unshift({ timestamp, code });
      if (history.length > 20) history = history.slice(0, 20);
      localStorage.setItem('aegis_history', JSON.stringify(history));
      localStorage.setItem('aegis_last_checkin', timestamp);
      loadHistory();
    }

    function loadHistory() {
      const history = JSON.parse(localStorage.getItem('aegis_history') || '[]');
      const container = document.getElementById('checkinHistory');
      if (history.length === 0) { container.textContent = 'Noch keine Check-ins durchgefÃ¼hrt.'; return; }
      container.innerHTML = history.slice(0, 10).map(h => `
        <div class="file-item" style="margin-bottom: 6px;">
          <div class="file-item-info">
            <span class="file-item-icon">âœ…</span>
            <span class="file-item-name mono" style="font-size: 12px;">${h.code}</span>
          </div>
          <span class="file-item-size">${new Date(h.timestamp).toLocaleString('de-DE')}</span>
        </div>
      `).join('');
    }

    init();
  </script>
</body>
</html>
