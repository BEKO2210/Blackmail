<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AEGIS — Check-in</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="aegis-app">

    <header class="aegis-header">
      <a href="index.html" class="aegis-logo">
        <div class="aegis-logo-icon"><img src="asset/aegis-logo-256.png" alt="AEGIS"></div>
        <span class="aegis-logo-text" data-text="AEGIS">AEGIS</span>
      </a>
      <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation" aria-expanded="false">
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
        <span class="nav-toggle-bar"></span>
      </button>
      <nav class="aegis-nav" id="aegisNav">
        <div class="nav-links">
          <a href="index.html" data-i18n="nav.home">Home</a>
          <a href="setup.html" data-i18n="nav.setup">Setup</a>
          <a href="checkin.html" data-i18n="nav.checkin">Check-in</a>
          <a href="guardian.html" data-i18n="nav.guardian">Guardian</a>
          <a href="verify.html" data-i18n="nav.verify">Verify</a>
          <a href="howitworks.html" data-i18n="nav.howitworks">How It Works</a>
          <div class="nav-divider"></div>
          <a href="privacy.html" data-i18n="nav.privacy">Privacy</a>
          <a href="imprint.html" data-i18n="nav.imprint">Imprint</a>
        </div>
        <div class="lang-toggle">
          <button class="lang-btn active" data-lang="en">EN</button>
          <button class="lang-btn" data-lang="de">DE</button>
        </div>
      </nav>
    </header>

    <main class="aegis-main">
      <h1 data-i18n="checkin.title">Check-in</h1>
      <p class="subtitle" data-i18n="checkin.subtitle">Check in regularly to reset the Dead Man's Switch.</p>

      <!-- Status Card -->
      <div class="card status-card" id="statusCard" style="display:none">
        <div class="status-header">
          <span class="status-icon" id="statusIcon"></span>
          <div class="status-info">
            <div class="status-level" id="statusLevel"></div>
            <div class="status-times">
              <span data-i18n="checkin.status.last">Last check-in:</span> <span id="statusLastCheckin"></span><br>
              <span data-i18n="checkin.status.next">Next due:</span> <span id="statusNextDue"></span>
            </div>
          </div>
        </div>
        <div class="checkin-progress">
          <div class="checkin-progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- No Config Warning -->
      <div class="alert alert-warning" id="noConfigAlert" style="display:none">
        <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4m0 4h.01"/></svg></span>
        <div data-i18n="checkin.noconfig">No AEGIS profile found. Please complete the <a href="setup.html" style="color: inherit; font-weight: 600;">Setup</a> first.</div>
      </div>

      <!-- Passphrase Input Card -->
      <div class="card" id="checkinCard">
        <div class="card-header">
          <h2 class="card-title" data-i18n="checkin.passphrase.title">Enter Passphrase</h2>
          <p class="card-desc" data-i18n="checkin.passphrase.desc">Enter your passphrase to generate a check-in token. Send the token to your guardians.</p>
        </div>

        <div class="form-group">
          <label class="form-label" data-i18n="checkin.passphrase.label">Passphrase</label>
          <input type="password" id="checkinPass" class="form-input form-input-mono"
                 data-i18n-placeholder="checkin.passphrase.placeholder" placeholder="Your passphrase..."
                 autocomplete="off">
        </div>

        <div class="alert alert-warning hidden" id="checkinError">
          <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4m0 4h.01"/></svg></span>
          <span id="checkinErrorText"></span>
        </div>

        <button class="btn btn-primary btn-block btn-lg" id="checkinBtn" data-i18n="checkin.btn.checkin">Perform Check-in</button>
      </div>

      <!-- Token Result Section -->
      <div id="tokenResult" class="hidden">
        <div class="token-display" id="tokenDisplay">
          <div style="font-size: 14px; font-weight: 500; color: var(--text-secondary);" data-i18n="checkin.token.label">Your Check-in Token</div>
          <div class="token-code" id="tokenCode">&mdash;</div>
          <div class="token-time" id="tokenTime">&mdash;</div>
        </div>

        <div class="card">
          <h3 class="card-title mb-4" data-i18n="checkin.token.send.title">Send Token to Guardians</h3>
          <p class="card-desc mb-4" data-i18n="checkin.token.send.desc">Copy the full token and send it to your guardians. They can verify it on the Guardian page.</p>
          <div class="hash-display" id="fullToken" style="font-size: 11px;">
            <button class="copy-btn" id="copyBtnInline"></button>
            <span id="fullTokenText">&mdash;</span>
          </div>
          <div class="btn-group" style="justify-content: center;">
            <button class="btn btn-secondary" id="copyTokenBtn"></button>
            <button class="btn btn-secondary" id="saveTokenBtn"></button>
          </div>
        </div>

        <div class="alert alert-info mt-4">
          <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h.01"/></svg></span>
          <div><span data-i18n="checkin.token.next"><strong>Next check-in:</strong></span> <span id="nextCheckin">&mdash;</span><br><span data-i18n="checkin.token.channel">Send the token via a secure channel (Signal, in person, etc.)</span></div>
        </div>
      </div>

      <!-- GitHub Automated Heartbeat Card -->
      <div class="card mt-6" id="githubCard">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
          <h3 class="card-title" data-i18n="github.title">Automated Monitoring</h3>
          <span class="github-status-badge disconnected" id="githubBadge">
            <span class="github-status-dot"></span>
            <span id="githubBadgeText" data-i18n="github.status.inactive">Not configured</span>
          </span>
        </div>
        <p class="card-desc mb-4" data-i18n="github.desc">Optionally update the GitHub heartbeat to enable automated guardian notifications.</p>

        <div id="githubNotConfigured">
          <div class="alert alert-info">
            <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4m0-4h.01"/></svg></span>
            <div data-i18n="github.notconfigured">GitHub automation is not configured. <a href="setup.html" style="color: inherit; font-weight: 600;">Configure in Setup</a> to enable automated guardian notifications.</div>
          </div>
        </div>

        <div id="githubConfigured" style="display:none">
          <div class="alert alert-success" id="githubStatusAlert">
            <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg></span>
            <div><span data-i18n="github.connected">Connected to</span> <strong id="githubRepoName" class="mono"></strong></div>
          </div>

          <button class="btn btn-primary btn-block" id="githubCheckinBtn">
            <svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
            <span data-i18n="github.btn">Update Heartbeat on GitHub</span>
          </button>

          <div class="alert alert-success hidden mt-4" id="githubSuccess">
            <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg></span>
            <div id="githubSuccessText"></div>
          </div>

          <div class="alert alert-danger hidden mt-4" id="githubError">
            <span class="alert-icon"><svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span>
            <div id="githubErrorText"></div>
          </div>

          <div class="form-hint mt-4" data-i18n="github.hint">This updates the heartbeat timestamp in your repository. The GitHub Actions workflow monitors this and notifies guardians if check-ins stop.</div>
        </div>
      </div>

      <!-- History Card -->
      <div class="card mt-6" id="historyCard">
        <h3 class="card-title" data-i18n="checkin.history.title">Recent Check-ins</h3>
        <div id="checkinHistory" class="mt-4 text-sm text-muted"></div>
      </div>
    </main>

    <footer class="aegis-footer">
      <div class="footer-links">
        <a href="privacy.html" data-i18n="footer.privacy">Privacy</a>
        <span class="footer-sep">|</span>
        <a href="imprint.html" data-i18n="footer.imprint">Imprint</a>
        <span class="footer-sep">|</span>
        <a href="howitworks.html" data-i18n="footer.howitworks">How It Works</a>
      </div>
      <p data-i18n="footer.text">AEGIS — No data leaves your browser</p>
    </footer>

  </div>

  <script src="js/icons.js"></script>
  <script src="js/crypto.js"></script>
  <script src="js/checkin.js"></script>
  <script src="js/github-checkin.js"></script>
  <script src="js/lang.js"></script>
  <script src="js/main.js"></script>
  <script>
    'use strict';

    var config = null;
    var lastToken = null;

    document.addEventListener('aegis-ready', function () {
      init();
    });

    function init() {
      var stored = localStorage.getItem('aegis_config');
      if (!stored) {
        document.getElementById('noConfigAlert').style.display = 'flex';
        renderHistory();
        initGitHubCard();
        return;
      }
      config = JSON.parse(stored);
      updateStatusCard();
      renderHistory();
      updateButtonLabels();
      initGitHubCard();
    }

    function initGitHubCard() {
      if (AegisGitHub.isConfigured()) {
        document.getElementById('githubNotConfigured').style.display = 'none';
        document.getElementById('githubConfigured').style.display = '';
        var ghConfig = AegisGitHub.getConfig();
        document.getElementById('githubRepoName').textContent = ghConfig.owner + '/' + ghConfig.repo;
        var badge = document.getElementById('githubBadge');
        badge.classList.remove('disconnected');
        document.getElementById('githubBadgeText').textContent = AegisLang.t('github.status.active');
        badge.querySelector('.github-status-dot').classList.add('heartbeat-pulse');
      } else {
        document.getElementById('githubNotConfigured').style.display = '';
        document.getElementById('githubConfigured').style.display = 'none';
      }
    }

    document.getElementById('githubCheckinBtn').addEventListener('click', function() {
      doGitHubHeartbeat();
    });

    async function doGitHubHeartbeat() {
      var btn = document.getElementById('githubCheckinBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg class="aegis-icon" style="animation: spin 1s linear infinite;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg> ' + AegisLang.t('github.updating');

      document.getElementById('githubSuccess').classList.add('hidden');
      document.getElementById('githubError').classList.add('hidden');

      var result = await AegisGitHub.performHeartbeat();

      btn.disabled = false;
      btn.innerHTML = '<svg class="aegis-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg> ' + AegisLang.t('github.btn');

      if (result.success) {
        document.getElementById('githubSuccess').classList.remove('hidden');
        var locale = AegisLang.getLocale();
        document.getElementById('githubSuccessText').textContent = AegisLang.t('github.success') + ' ' + new Date(result.timestamp).toLocaleString(locale);
      } else {
        document.getElementById('githubError').classList.remove('hidden');
        document.getElementById('githubErrorText').textContent = AegisLang.t('github.error') + ' ' + result.error;
      }
    }

    function updateButtonLabels() {
      document.getElementById('copyBtnInline').textContent = AegisLang.t('copy');
      document.getElementById('copyTokenBtn').innerHTML = AegisIcons.clipboard + ' ' + AegisLang.t('checkin.token.copy');
      document.getElementById('saveTokenBtn').innerHTML = AegisIcons.download + ' ' + AegisLang.t('checkin.token.save');
    }

    function updateStatusCard() {
      if (!config) return;
      var lastCheckinTime = localStorage.getItem('aegis_last_checkin');
      var statusCard = document.getElementById('statusCard');
      var level = AegisCheckin.getEscalationLevel(lastCheckinTime, config.interval);
      var escalation = AegisCheckin.ESCALATION_LABELS[level] || AegisCheckin.ESCALATION_LABELS[4];

      statusCard.style.display = '';
      statusCard.className = 'card status-card';
      if (level === 1) {
        statusCard.classList.add('warn');
      } else if (level >= 2) {
        statusCard.classList.add('danger');
      }

      document.getElementById('statusIcon').innerHTML = escalation.icon;
      document.getElementById('statusIcon').style.color = escalation.color;
      document.getElementById('statusLevel').textContent = AegisLang.t('escalation.' + level);
      document.getElementById('statusLevel').style.color = escalation.color;

      var locale = AegisLang.getLocale();
      if (lastCheckinTime) {
        document.getElementById('statusLastCheckin').textContent = new Date(lastCheckinTime).toLocaleString(locale);
        var nextDue = new Date(new Date(lastCheckinTime).getTime() + config.interval * 60 * 60 * 1000);
        document.getElementById('statusNextDue').textContent = nextDue.toLocaleString(locale);

        var now = Date.now();
        var start = new Date(lastCheckinTime).getTime();
        var end = nextDue.getTime();
        var elapsed = now - start;
        var total = end - start;
        var percent = Math.min(Math.max((elapsed / total) * 100, 0), 100);
        var progressFill = document.getElementById('progressFill');
        progressFill.style.width = percent + '%';
        if (level === 0) {
          progressFill.style.backgroundColor = '#22c55e';
        } else if (level === 1) {
          progressFill.style.backgroundColor = '#eab308';
        } else {
          progressFill.style.backgroundColor = '#ef4444';
        }
      } else {
        document.getElementById('statusLastCheckin').textContent = AegisLang.t('checkin.status.none');
        document.getElementById('statusNextDue').textContent = '—';
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressFill').style.backgroundColor = '#dc2626';
      }
    }

    document.getElementById('checkinPass').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') performCheckin();
    });

    document.getElementById('checkinBtn').addEventListener('click', function () {
      performCheckin();
    });

    async function performCheckin() {
      if (!config) {
        document.getElementById('noConfigAlert').style.display = 'flex';
        return;
      }
      var input = document.getElementById('checkinPass').value;
      if (!input) {
        showCheckinError(AegisLang.t('checkin.error.empty'));
        return;
      }

      var inputHash = await AegisCrypto.sha256(input);
      var isNormal = inputHash === config.passphraseHash;
      var isDuress = inputHash === config.duressHash;
      if (!isNormal && !isDuress) {
        showCheckinError(AegisLang.t('checkin.error.invalid'));
        return;
      }
      hideCheckinError();

      var timestamp = new Date().toISOString();
      var nonce = AegisCrypto.generateId(8);
      var payload = { t: timestamp, n: nonce, p: config.packageId, _d: isDuress ? '1' : '0' };
      var tokenString = JSON.stringify(payload);
      var tokenHash = await AegisCrypto.sha256(tokenString);

      var token = {
        aegis_checkin: true,
        version: '1.0.0',
        timestamp: timestamp,
        package: config.packageId,
        token: tokenHash,
        payload: btoa(tokenString)
      };
      lastToken = token;

      var locale = AegisLang.getLocale();
      var displayCode = 'AEGIS-' + tokenHash.substring(0, 8).toUpperCase() + '-' + timestamp.split('T')[0];
      document.getElementById('tokenCode').textContent = displayCode;
      document.getElementById('tokenTime').textContent = new Date(timestamp).toLocaleString(locale);
      document.getElementById('fullTokenText').textContent = JSON.stringify(token);

      var nextDate = new Date(Date.now() + config.interval * 60 * 60 * 1000);
      document.getElementById('nextCheckin').textContent = nextDate.toLocaleString(locale);

      document.getElementById('tokenResult').classList.remove('hidden');
      document.getElementById('tokenResult').classList.add('animate-in');
      saveCheckin(timestamp, displayCode);
      updateStatusCard();
      document.getElementById('checkinPass').value = '';
      document.getElementById('tokenResult').scrollIntoView({ behavior: 'smooth' });

      // Auto-trigger GitHub heartbeat if configured
      if (AegisGitHub.isConfigured()) {
        doGitHubHeartbeat();
      }
    }

    function showCheckinError(msg) {
      document.getElementById('checkinError').classList.remove('hidden');
      document.getElementById('checkinErrorText').textContent = msg;
    }

    function hideCheckinError() {
      document.getElementById('checkinError').classList.add('hidden');
    }

    function copyToken() {
      if (!lastToken) return;
      navigator.clipboard.writeText(JSON.stringify(lastToken)).then(function () {
        var copyText = AegisLang.t('copied');
        document.getElementById('copyBtnInline').textContent = copyText;
        document.getElementById('copyTokenBtn').innerHTML = AegisIcons.checkSmall + ' ' + copyText;
        setTimeout(function () {
          document.getElementById('copyBtnInline').textContent = AegisLang.t('copy');
          document.getElementById('copyTokenBtn').innerHTML = AegisIcons.clipboard + ' ' + AegisLang.t('checkin.token.copy');
        }, 2000);
      });
    }

    document.getElementById('copyBtnInline').addEventListener('click', function () {
      copyToken();
    });

    document.getElementById('copyTokenBtn').addEventListener('click', function () {
      copyToken();
    });

    document.getElementById('saveTokenBtn').addEventListener('click', function () {
      downloadToken();
    });

    function downloadToken() {
      if (!lastToken) return;
      var blob = new Blob([JSON.stringify(lastToken, null, 2)], { type: 'application/json' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'aegis-checkin-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function saveCheckin(timestamp, code) {
      var history = JSON.parse(localStorage.getItem('aegis_history') || '[]');
      history.unshift({ timestamp: timestamp, code: code });
      if (history.length > 20) history = history.slice(0, 20);
      localStorage.setItem('aegis_history', JSON.stringify(history));
      localStorage.setItem('aegis_last_checkin', timestamp);
      renderHistory();
    }

    function renderHistory() {
      var history = JSON.parse(localStorage.getItem('aegis_history') || '[]');
      var container = document.getElementById('checkinHistory');
      if (history.length === 0) {
        container.textContent = AegisLang.t('checkin.history.empty');
        return;
      }
      var locale = AegisLang.getLocale();
      container.innerHTML = history.slice(0, 10).map(function (h) {
        return '<div class="file-item" style="margin-bottom: 6px;">' +
          '<div class="file-item-info">' +
          '<span class="file-item-icon">' + AegisIcons.check + '</span>' +
          '<span class="file-item-name mono" style="font-size: 12px;">' + escapeHtml(h.code) + '</span>' +
          '</div>' +
          '<span class="file-item-size">' + new Date(h.timestamp).toLocaleString(locale) + '</span>' +
          '</div>';
      }).join('');
    }

    document.addEventListener('aegis-lang-change', function () {
      renderHistory();
      updateStatusCard();
      updateButtonLabels();
    });
  </script>
</body>
</html>
