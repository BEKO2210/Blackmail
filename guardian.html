<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AEGIS ‚Äî Guardian</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="aegis-app">

    <header class="aegis-header">
      <a href="index.html" class="aegis-logo">
        <div class="aegis-logo-icon">A</div>
        <span class="aegis-logo-text">AEGIS</span>
      </a>
      <nav class="aegis-nav">
        <a href="setup.html">Setup</a>
        <a href="checkin.html">Check-in</a>
        <a href="guardian.html" class="active">Guardian</a>
        <a href="verify.html">Verify</a>
      </nav>
    </header>

    <main class="aegis-main">
      <h1>Guardian Dashboard</h1>
      <p class="subtitle">Verifiziere Check-in-Tokens und rekonstruiere bei Eskalation.</p>

      <!-- Token Verification -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üîç Token verifizieren</h2>
          <p class="card-desc">F√ºge das Check-in-Token ein, das du erhalten hast.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Check-in Token (JSON)</label>
          <textarea id="tokenInput" class="form-textarea form-input-mono" rows="5"
                    placeholder='{"aegis_checkin": true, "timestamp": "...", ...}'></textarea>
        </div>

        <button class="btn btn-primary btn-block" onclick="verifyToken()">üîç Token pr√ºfen</button>

        <div id="verifyResult" class="hidden mt-6 animate-in">
          <div id="verifyOk" class="alert alert-success hidden">
            <span class="alert-icon">‚úÖ</span>
            <div><strong>Token g√ºltig</strong><br><span id="verifyOkDetails"></span></div>
          </div>
          <div id="verifyDuress" class="alert alert-danger hidden">
            <span class="alert-icon">üö®</span>
            <div>
              <strong>DURESS ERKANNT ‚Äî Person ist m√∂glicherweise in Gefahr!</strong><br>
              Die Person wurde gezwungen sich zu melden. Das Token sieht normal aus, enth√§lt aber ein verstecktes Warnsignal.<br><br>
              <strong>Sofort Eskalationsstufe 3 einleiten!</strong><br>
              Kontaktiere andere Guardians und beginne mit der Fragment-Zusammenf√ºhrung.
            </div>
          </div>
          <div id="verifyInvalid" class="alert alert-warning hidden">
            <span class="alert-icon">‚ùå</span>
            <div><strong>Token ung√ºltig</strong><br><span id="verifyInvalidDetails"></span></div>
          </div>
        </div>
      </div>

      <!-- Fragment Assembly -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üß© Fragmente zusammenf√ºhren</h2>
          <p class="card-desc">Wenn die Eskalation erreicht wurde, k√∂nnen Guardians hier ihre Fragmente kombinieren, um die Beweise zu entschl√ºsseln.</p>
        </div>

        <div class="alert alert-warning">
          <span class="alert-icon">‚ö†Ô∏è</span>
          <div>F√ºhre Fragmente nur zusammen, wenn die Eskalationsbedingungen erf√ºllt sind. Alle beteiligten Guardians m√ºssen zustimmen.</div>
        </div>

        <div id="fragmentInputs">
          <div class="form-group">
            <label class="form-label">Guardian-Kit #1</label>
            <textarea class="form-textarea form-input-mono fragment-input" rows="3" placeholder="Guardian-Kit JSON hier einf√ºgen..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Guardian-Kit #2</label>
            <textarea class="form-textarea form-input-mono fragment-input" rows="3" placeholder="Guardian-Kit JSON hier einf√ºgen..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Guardian-Kit #3</label>
            <textarea class="form-textarea form-input-mono fragment-input" rows="3" placeholder="Guardian-Kit JSON hier einf√ºgen..."></textarea>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-ghost" onclick="addFragmentInput()">+ Weiteres Fragment</button>
          <button class="btn btn-danger" onclick="assembleFragments()">üîì Passphrase rekonstruieren</button>
        </div>

        <div id="assemblyResult" class="hidden mt-6">
          <div class="alert alert-success" id="assemblySuccess" style="display:none">
            <span class="alert-icon">üîì</span>
            <div><strong>Passphrase erfolgreich rekonstruiert!</strong><br>Verwende diese Passphrase um das Evidenz-Paket zu entschl√ºsseln.</div>
          </div>
          <div class="hash-display" id="recoveredPassphrase" style="display:none">
            <button class="copy-btn" onclick="copyRecovered()">Kopieren</button>
            <span id="recoveredText">‚Äî</span>
          </div>
          <div class="alert alert-danger" id="assemblyError" style="display:none">
            <span class="alert-icon">‚ùå</span>
            <span id="assemblyErrorText"></span>
          </div>
        </div>
      </div>

      <!-- Decrypt Package -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üì¶ Paket entschl√ºsseln</h2>
          <p class="card-desc">Lade das verschl√ºsselte Evidenz-Paket und gib die rekonstruierte Passphrase ein.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Evidenz-Paket (JSON-Datei)</label>
          <input type="file" id="packageFile" accept=".json" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label">Passphrase</label>
          <input type="password" id="decryptPass" class="form-input form-input-mono" placeholder="Rekonstruierte Passphrase...">
        </div>

        <button class="btn btn-primary btn-block" onclick="decryptPackage()">üîì Entschl√ºsseln</button>

        <div id="decryptResult" class="hidden mt-6">
          <div class="alert alert-success" id="decryptSuccess" style="display:none">
            <span class="alert-icon">üìÇ</span>
            <div><strong>Erfolgreich entschl√ºsselt!</strong><br><span id="decryptDetails"></span></div>
          </div>
          <div id="decryptedFiles"></div>
          <div class="alert alert-danger" id="decryptError" style="display:none">
            <span class="alert-icon">‚ùå</span>
            <span id="decryptErrorText">Entschl√ºsselung fehlgeschlagen. Falsche Passphrase?</span>
          </div>
        </div>
      </div>
    </main>

    <footer class="aegis-footer">AEGIS v1.0 ‚Äî Guardian Edition</footer>
  </div>

  <script src="crypto.js"></script>
  <script src="shamir.js"></script>
  <script src="checkin.js"></script>
  <script>
    'use strict';

    async function verifyToken() {
      const input = document.getElementById('tokenInput').value.trim();
      if (!input) return;
      const resultDiv = document.getElementById('verifyResult');
      resultDiv.classList.remove('hidden');
      document.getElementById('verifyOk').classList.add('hidden');
      document.getElementById('verifyDuress').classList.add('hidden');
      document.getElementById('verifyInvalid').classList.add('hidden');

      try {
        const token = JSON.parse(input);
        if (!token.aegis_checkin) throw new Error('Not an AEGIS token');
        const result = await AegisCheckin.verifyToken(token);

        if (result.status === 'DURESS') {
          document.getElementById('verifyDuress').classList.remove('hidden');
        } else if (result.valid) {
          document.getElementById('verifyOk').classList.remove('hidden');
          document.getElementById('verifyOkDetails').innerHTML = 
            `Zeitstempel: ${new Date(result.timestamp).toLocaleString('de-DE')}<br>Alter: ${result.ageHours} Stunden<br>Paket-ID: ${result.packageId.substring(0, 16)}...`;
        } else {
          document.getElementById('verifyInvalid').classList.remove('hidden');
          document.getElementById('verifyInvalidDetails').textContent = result.error || 'Hash-Pr√ºfung fehlgeschlagen.';
        }
      } catch (e) {
        document.getElementById('verifyInvalid').classList.remove('hidden');
        document.getElementById('verifyInvalidDetails').textContent = 'Ung√ºltiges Token-Format: ' + e.message;
      }
    }

    let fragmentCount = 3;
    function addFragmentInput() {
      fragmentCount++;
      const div = document.createElement('div');
      div.className = 'form-group animate-in';
      div.innerHTML = `<label class="form-label">Guardian-Kit #${fragmentCount}</label><textarea class="form-textarea form-input-mono fragment-input" rows="3" placeholder="Guardian-Kit JSON hier einf√ºgen..."></textarea>`;
      document.getElementById('fragmentInputs').appendChild(div);
    }

    function assembleFragments() {
      const inputs = document.querySelectorAll('.fragment-input');
      const shares = [];
      document.getElementById('assemblyResult').classList.remove('hidden');
      document.getElementById('assemblySuccess').style.display = 'none';
      document.getElementById('recoveredPassphrase').style.display = 'none';
      document.getElementById('assemblyError').style.display = 'none';

      try {
        for (const input of inputs) {
          const val = input.value.trim();
          if (!val) continue;
          const kit = JSON.parse(val);
          const share = kit.aegis_guardian_kit ? kit.share : kit;
          shares.push(AegisShamir.importShare(share));
        }
        if (shares.length < 2) {
          document.getElementById('assemblyError').style.display = 'flex';
          document.getElementById('assemblyErrorText').textContent = `Mindestens ${shares[0]?.threshold || 2} Fragmente ben√∂tigt. Aktuell: ${shares.length}`;
          return;
        }
        const threshold = shares[0].threshold;
        if (shares.length < threshold) {
          document.getElementById('assemblyError').style.display = 'flex';
          document.getElementById('assemblyErrorText').textContent = `${threshold} Fragmente ben√∂tigt, aber nur ${shares.length} vorhanden.`;
          return;
        }
        const recovered = AegisShamir.combine(shares);
        const passphrase = new TextDecoder().decode(recovered);
        document.getElementById('assemblySuccess').style.display = 'flex';
        document.getElementById('recoveredPassphrase').style.display = 'block';
        document.getElementById('recoveredText').textContent = passphrase;
        document.getElementById('decryptPass').value = passphrase;
      } catch (e) {
        document.getElementById('assemblyError').style.display = 'flex';
        document.getElementById('assemblyErrorText').textContent = 'Rekonstruktion fehlgeschlagen: ' + e.message;
      }
    }

    function copyRecovered() {
      navigator.clipboard.writeText(document.getElementById('recoveredText').textContent).then(() => {
        const btn = document.querySelector('#recoveredPassphrase .copy-btn');
        btn.textContent = '‚úì Kopiert'; setTimeout(() => btn.textContent = 'Kopieren', 2000);
      });
    }

    async function decryptPackage() {
      const fileInput = document.getElementById('packageFile');
      const passphrase = document.getElementById('decryptPass').value;
      const resultDiv = document.getElementById('decryptResult');
      resultDiv.classList.remove('hidden');
      document.getElementById('decryptSuccess').style.display = 'none';
      document.getElementById('decryptError').style.display = 'none';
      document.getElementById('decryptedFiles').innerHTML = '';

      if (!fileInput.files.length) { document.getElementById('decryptError').style.display = 'flex'; document.getElementById('decryptErrorText').textContent = 'Bitte eine Paket-Datei ausw√§hlen.'; return; }
      if (!passphrase) { document.getElementById('decryptError').style.display = 'flex'; document.getElementById('decryptErrorText').textContent = 'Bitte Passphrase eingeben.'; return; }

      try {
        const fileContent = await fileInput.files[0].text();
        const pkg = JSON.parse(fileContent);
        if (!pkg.aegis) throw new Error('Keine g√ºltige AEGIS-Paketdatei.');

        const result = await AegisCrypto.decryptEvidencePackage(pkg, passphrase);
        document.getElementById('decryptSuccess').style.display = 'flex';
        document.getElementById('decryptDetails').textContent = `${result.files.length} Datei(en) entschl√ºsselt. Erstellt: ${new Date(result.manifest.created).toLocaleString('de-DE')}`;

        const container = document.getElementById('decryptedFiles');
        if (result.manifest.metadata?.note) {
          container.innerHTML += `<div class="card mt-4" style="background: var(--aegis-blue-subtle); border: none;"><h3>üìù Notiz</h3><p class="mt-4 text-sm">${escapeHtml(result.manifest.metadata.note)}</p></div>`;
        }
        for (const file of result.files) {
          const blob = new Blob([file.data], { type: file.type });
          const url = URL.createObjectURL(blob);
          container.innerHTML += `<div class="file-item mt-4"><div class="file-item-info"><span class="file-item-icon">${getFileIcon(file.type)}</span><span class="file-item-name">${escapeHtml(file.name)}</span></div><a href="${url}" download="${escapeHtml(file.name)}" class="btn btn-secondary" style="font-size: 12px;">üíæ Herunterladen</a></div>`;
        }
      } catch (e) {
        document.getElementById('decryptError').style.display = 'flex';
        document.getElementById('decryptErrorText').textContent = 'Entschl√ºsselung fehlgeschlagen: ' + e.message;
      }
    }

    function getFileIcon(type) { if (!type) return 'üìé'; if (type.startsWith('image/')) return 'üñºÔ∏è'; if (type.startsWith('video/')) return 'üé¨'; if (type.startsWith('audio/')) return 'üéµ'; if (type.includes('pdf')) return 'üìÑ'; return 'üìé'; }
    function escapeHtml(str) { const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
  </script>
</body>
</html>
